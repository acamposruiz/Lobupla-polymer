<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">

<dom-module id="lob-form">
  <template>
    <div class="horizontal-section">
      <form is="iron-form" id="formGet" method="get" action="/">
        Find
        <paper-dropdown-menu label="Venue type" name="venue_type" required>
          <paper-menu class="dropdown-content" selected="0">
            <template is="dom-repeat" items="{{venue_types}}">
              <paper-item value="{{item}}">{{item}}</paper-item>
            </template>
          </paper-menu>
        </paper-dropdown-menu>
        near to
        <paper-input name="location" label="Location" value="{{location}}" required></paper-input>
        <br><br>

        <paper-button raised
                      on-click="_onClick">Submit
        </paper-button>
      </form>
    </div>
    <lob-map data="[[dataMap]]"></lob-map>
    <iron-ajax
      auto
      url="https://api.foursquare.com/v2/venues/explore"
      params='{{params}}'
      handle-as="json"
      last-response="{{response}}"
      debounce-duration="300"></iron-ajax>
    <iron-ajax
      auto
      url="http://maps.googleapis.com/maps/api/geocode/json"
      params='{{paramsGoogleapis}}'
      handle-as="json"
      last-response="{{responseGoogleapis}}"
      debounce-duration="300"></iron-ajax>
    <iron-ajax
      auto
      url="http://maps.googleapis.com/maps/api/geocode/json"
      params='{{paramsAddressFromCoordinates}}'
      handle-as="json"
      last-response="{{responseAddressFromCoordinates}}"
      debounce-duration="300"></iron-ajax>
  </template>
  <script>
    (function () {
      'use strict';

      var coordenates = {},
        paramsGoogleapis = {},
        params = {
          client_id: 'WU3OIROB5N3J1U3JPWWP0EUVICAZTMDCL2MUFLM2RKZ4HZFO',
          client_secret: 'YF3BCWYDRXLSRUOSJ24WDBKWFZMYDGS1EYF5TSHM2O35VACU',
          //ll: data.coordinates,
          ll: '',
          section: 'food',
          venuePhotos: 1,
          sortByDistance: 1,
          radius: 1000,
          limit: 7,
          offset: 0,
          v: '20150217'
        };

      navigator.geolocation.getCurrentPosition(GetLocation);

      function GetLocation(location) {
        coordenates = {lat: location.coords.latitude, lng: location.coords.longitude};
        params.ll = coordenates.lat + ',' + coordenates.lng;

        Polymer({
          is: 'lob-form',
          properties: {
            venue_types: {
              type: Array,
              value: ['food', 'drinks', 'coffee', 'shops', 'arts', 'outdoors', 'sights', 'trending', 'specials', 'topPicks']
            },
            location: {
              type: String,
              value: '',
              notify: true
            },
            dataMap: {
              type: Object,
              value: {},
              notify: true
            },
            params: {
              type: Object,
              value: params,
              notify: true
            },
            responseGoogleapis: {
              type: Object,
              value: {},
              observer: 'responseGoogleapisObserve',
              notify: true
            },
            responseAddressFromCoordinates: {
              type: Object,
              value: {},
              observer: 'responseAddressFromCoordinatesObserve',
              notify: true
            },
            response: {
              type: Object,
              value: {},
              observer: 'responseObserve',
              notify: true
            }
          },
          responseGoogleapisObserve: function (responseGoogleapis) {
            var that = this;
            try {
              coordenates = {
                lat: responseGoogleapis.results[0].geometry.location.lat,
                lng: responseGoogleapis.results[0].geometry.location.lng
              };
              params.ll = coordenates.lat + ',' + coordenates.lng;
              that.params = Object.create(params);
            } catch (e) {
            }
          },
          responseAddressFromCoordinatesObserve: function (responseGoogleapis) {
            try {
              this.location = responseGoogleapis.results[0].formatted_address;
            } catch (e) {
            }
          },
          responseObserve: function (data) {
            try {
              this.dataMap = {
                venues: data.response.groups[0].items,
                coordenates: coordenates
              };
            } catch (e) {
            }
          },
          attached: function () {
            var that = this;
            that.paramsAddressFromCoordinates = {
              sensor: 'true_or_false',
              latlng: params.ll
            };
            document.getElementById('formGet').addEventListener('iron-form-submit', function (event) {
              try {
                var paramsGoogleapis = {
                  address: event.detail.location,
                  components: 'country:ES'
                };
                params.section = event.detail.venue_type;
                that.paramsGoogleapis = Object.create(paramsGoogleapis);
              } catch (e) {
              }
            });
          },
          _onClick: function (event) {
            Polymer.dom(event).localTarget.parentElement.submit();
          }
        });
      }
    })();
  </script>
</dom-module>
